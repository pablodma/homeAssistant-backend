---
description: Reglas del Calendar Agent - Integración con Google Calendar
globs:
  - "**/calendar*.py"
  - "**/event_detector.py"
  - "**/google_calendar.py"
---

# Calendar Agent

## Descripción
El Calendar Agent gestiona eventos del calendario con sincronización bidireccional a Google Calendar. Funciona como sub-agente dentro del bot homeai-assis, usando LLM + tools que llaman al backend.

## Arquitectura Actual

```
┌─────────────────────────────────────────────────────────────────┐
│                    FLUJO DE MENSAJE                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Usuario (WhatsApp)                                              │
│      │                                                           │
│      ▼                                                           │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │   homeai-assis: Webhook → RouterAgent (LLM)               │   │
│  │   Si intención = calendario → CalendarAgent               │   │
│  └────────────────────────┬─────────────────────────────────┘   │
│                           │                                      │
│                           ▼                                      │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │   homeai-assis: CalendarAgent (LLM + tools)               │   │
│  │   Tools: crear_evento, listar_eventos, modificar, etc.   │   │
│  └────────────────────────┬─────────────────────────────────┘   │
│                           │                                      │
│                           │ HTTP (Bearer token)                   │
│                           ▼                                      │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │   homeai-api: Calendar Router                             │   │
│  │   /api/v1/tenants/{id}/agent/calendar/events              │   │
│  └────────────────────────┬─────────────────────────────────┘   │
│                           │                                      │
│  ┌────────────────────────▼────────────────────────────────┐   │
│  │   Calendar Service + Google Calendar sync                 │   │
│  │   • Event CRUD en PostgreSQL                             │   │
│  │   • Sincronización bidireccional Google                   │   │
│  │   • Event detection (NLP) en event_detector.py            │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## Endpoints del Backend (usados por CalendarAgent)

| Endpoint | Método | Descripción |
|----------|--------|-------------|
| `/api/v1/tenants/{id}/agent/calendar/events` | POST | Crear evento |
| `/api/v1/tenants/{id}/agent/calendar/events` | GET | Listar eventos |
| `/api/v1/tenants/{id}/agent/calendar/events/{event_id}` | PUT | Modificar evento |
| `/api/v1/tenants/{id}/agent/calendar/events/{event_id}` | DELETE | Eliminar evento |
| `/api/v1/tenants/{id}/agent/calendar/detect` | POST | Detectar evento en mensaje (NLP) |
| `/api/v1/tenants/{id}/agent/calendar/availability` | GET | Verificar disponibilidad |
| `/api/v1/tenants/{id}/agent/calendar/connection-status` | GET | Estado de Google Calendar |
| `/api/v1/tenants/{id}/agent/calendar/next` | GET | Próximo evento |

## Modelo de Datos

### Tablas

```sql
-- Eventos
events (
    id UUID PRIMARY KEY,
    tenant_id UUID NOT NULL,
    title VARCHAR(200),
    start_datetime TIMESTAMPTZ,
    end_datetime TIMESTAMPTZ,
    google_event_id VARCHAR(255),  -- Sync con Google
    sync_status VARCHAR(20),       -- local, synced, pending_sync, sync_failed
    source VARCHAR(20)             -- app, google
)

-- Credenciales Google Calendar
google_calendar_credentials (
    user_id UUID PRIMARY KEY,
    tenant_id UUID,
    access_token TEXT,
    refresh_token TEXT,
    token_expires_at TIMESTAMPTZ
)

-- Estados OAuth (temporales)
oauth_states (
    state VARCHAR(100) UNIQUE,
    user_phone VARCHAR(20),
    expires_at TIMESTAMPTZ
)
```

## Sincronización Google Calendar

### Crear evento con sync

```python
# El servicio automáticamente:
# 1. Crea evento en PostgreSQL
# 2. Si usuario tiene Google conectado → crea en Google Calendar
# 3. Guarda google_event_id para futura sincronización
# 4. Marca sync_status = "synced"
```

### Estados de sincronización

| Estado | Descripción |
|--------|-------------|
| `local` | Solo existe localmente |
| `synced` | Sincronizado con Google |
| `pending_sync` | Pendiente de sincronizar |
| `sync_failed` | Falló la sincronización |

## Variables de Entorno Requeridas

```bash
# Google OAuth
GOOGLE_CLIENT_ID=xxx.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=GOCSPX-xxx
GOOGLE_REDIRECT_URI=https://api.example.com/api/v1/auth/google/callback

# OAuth redirect URLs
CALENDAR_OAUTH_SUCCESS_URL=https://app.example.com/calendar/connected
CALENDAR_OAUTH_ERROR_URL=https://app.example.com/calendar/error

# OpenAI (para detección NLP en event_detector)
OPENAI_API_KEY=sk-xxx
```

## Ubicación del Código

| Componente | Ubicación |
|------------|-----------|
| CalendarAgent (LLM + tools) | homeai-assis/src/app/agents/calendar.py |
| Prompt del agente | homeai-assis/docs/prompts/calendar-agent.md |
| Backend endpoints | homeai-api/routers/calendar.py |
| Calendar Service | homeai-api/services/ |
| Event Detector (NLP) | homeai-api/services/event_detector.py |
| Google Calendar sync | homeai-api/services/google_calendar.py |
