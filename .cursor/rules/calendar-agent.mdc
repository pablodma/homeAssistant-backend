---
description: Reglas del Calendar Agent - IntegraciÃ³n con Google Calendar
globs:
  - "**/calendar*.py"
  - "**/event_detector.py"
  - "**/google_calendar.py"
---

# Calendar Agent

## DescripciÃ³n
El Calendar Agent gestiona eventos del calendario con sincronizaciÃ³n bidireccional a Google Calendar. Detecta eventos en conversaciones usando NLP (OpenAI).

## Arquitectura

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          n8n Workflow                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ WhatsApp â”‚â”€â”€â”€â–¶â”‚ Orquestador  â”‚â”€â”€â”€â–¶â”‚ Calendar Agent   â”‚     â”‚
â”‚  â”‚ Trigger  â”‚    â”‚    (LLM)     â”‚    â”‚  (HTTP Request)   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚              FastAPI Backend                 â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚  â”‚           Calendar Router               â”‚ â”‚
                    â”‚  â”‚     /api/v1/tenants/{id}/agent/...      â”‚ â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â”‚                      â”‚                       â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚  â”‚          Calendar Service               â”‚ â”‚
                    â”‚  â”‚  â€¢ Event CRUD                          â”‚ â”‚
                    â”‚  â”‚  â€¢ Google Calendar sync                â”‚ â”‚
                    â”‚  â”‚  â€¢ Event detection (NLP)               â”‚ â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â”‚          â”‚                â”‚                  â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚  â”‚  Repository   â”‚ â”‚  Google Calendar     â”‚ â”‚
                    â”‚  â”‚  (PostgreSQL) â”‚ â”‚  Service (API)       â”‚ â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Endpoints del Agent

### Para n8n HTTP Request Tool

| Endpoint | MÃ©todo | DescripciÃ³n |
|----------|--------|-------------|
| `/agent/calendar/event` | POST | Crear evento |
| `/agent/calendar/events` | GET | Listar eventos |
| `/agent/calendar/event/{id}` | PUT | Modificar evento |
| `/agent/calendar/event/{id}` | DELETE | Eliminar evento |
| `/agent/calendar/detect` | POST | Detectar evento en mensaje (NLP) |
| `/agent/calendar/availability` | GET | Verificar disponibilidad |
| `/agent/calendar/connection-status` | GET | Estado de Google Calendar |
| `/agent/calendar/next` | GET | PrÃ³ximo evento |

### OAuth Callback
| Endpoint | MÃ©todo | DescripciÃ³n |
|----------|--------|-------------|
| `/auth/google/callback` | GET | Callback de OAuth (sin tenant prefix) |

## Modelo de Datos

### Tablas

```sql
-- Eventos
events (
    id UUID PRIMARY KEY,
    tenant_id UUID NOT NULL,
    title VARCHAR(200),
    start_datetime TIMESTAMPTZ,
    end_datetime TIMESTAMPTZ,
    google_event_id VARCHAR(255),  -- Sync con Google
    sync_status VARCHAR(20),       -- local, synced, pending_sync, sync_failed
    source VARCHAR(20)             -- app, google
)

-- Credenciales Google Calendar
google_calendar_credentials (
    user_id UUID PRIMARY KEY,
    tenant_id UUID,
    access_token TEXT,
    refresh_token TEXT,
    token_expires_at TIMESTAMPTZ
)

-- Estados OAuth (temporales)
oauth_states (
    state VARCHAR(100) UNIQUE,
    user_phone VARCHAR(20),
    expires_at TIMESTAMPTZ
)
```

## Flujo OAuth via WhatsApp

```
Usuario (WhatsApp)        n8n                 Backend               Google
      â”‚                    â”‚                     â”‚                     â”‚
      â”œâ”€â”€â”€"Conectar calendario"â”€â”€â–¶               â”‚                     â”‚
      â”‚                    â”‚                     â”‚                     â”‚
      â”‚                    â”œâ”€â”€â”€connection-statusâ”€â–¶                     â”‚
      â”‚                    â”‚                     â”‚                     â”‚
      â”‚    â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"ConectÃ¡ tu cuenta: [URL]"â”€â”¤                     â”‚
      â”‚                    â”‚                     â”‚                     â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€click URLâ”€â”€â”€â”€â”€â”€â–¶
      â”‚                    â”‚                     â”‚                     â”‚
      â”‚                    â”‚                     â”‚â—€â”€â”€â”€â”€callback codeâ”€â”€â”€â”€â”¤
      â”‚                    â”‚                     â”‚                     â”‚
      â”‚                    â”‚                     â”œâ”€â”€â”€exchange tokenâ”€â”€â”€â”€â”€â–¶
      â”‚                    â”‚                     â”‚                     â”‚
      â”‚                    â”‚                     â”‚â—€â”€â”€â”€access/refreshâ”€â”€â”€â”€â”¤
      â”‚                    â”‚                     â”‚                     â”‚
      â”‚                    â”‚                     â”‚ (guarda tokens)      â”‚
      â”‚                    â”‚                     â”‚                     â”‚
      â”‚    â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€"âœ… Calendario conectado!"â”€â”€â”¤                     â”‚
```

## DetecciÃ³n de Eventos (NLP)

El servicio `event_detector.py` usa OpenAI GPT-4o-mini para:
- Detectar eventos agendables en mensajes de usuario
- Extraer: tÃ­tulo, fecha, hora, ubicaciÃ³n, duraciÃ³n
- Indicar nivel de confianza y campos faltantes

### Ejemplo de uso

```python
# Request
POST /agent/calendar/detect
{
    "message": "Tengo turno con el dentista maÃ±ana a las 10",
    "user_phone": "+5491155551234"
}

# Response
{
    "detected": true,
    "event_suggestion": {
        "title": "Turno dentista",
        "date": "2026-02-08",
        "time": "10:00"
    },
    "confidence": 0.92,
    "needs_confirmation": true,
    "message": "ğŸ“… DetectÃ© un evento: 'Turno dentista'\nğŸ“† MaÃ±ana a las 10:00\n\nÂ¿QuerÃ©s que lo agende?"
}
```

## SincronizaciÃ³n Google Calendar

### Crear evento con sync

```python
# El servicio automÃ¡ticamente:
# 1. Crea evento en PostgreSQL
# 2. Si usuario tiene Google conectado â†’ crea en Google Calendar
# 3. Guarda google_event_id para futura sincronizaciÃ³n
# 4. Marca sync_status = "synced"
```

### Estados de sincronizaciÃ³n

| Estado | DescripciÃ³n |
|--------|-------------|
| `local` | Solo existe localmente |
| `synced` | Sincronizado con Google |
| `pending_sync` | Pendiente de sincronizar |
| `sync_failed` | FallÃ³ la sincronizaciÃ³n |

## Variables de Entorno Requeridas

```bash
# Google OAuth
GOOGLE_CLIENT_ID=xxx.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=GOCSPX-xxx
GOOGLE_REDIRECT_URI=https://api.example.com/api/v1/auth/google/callback

# OAuth redirect URLs
CALENDAR_OAUTH_SUCCESS_URL=https://app.example.com/calendar/connected
CALENDAR_OAUTH_ERROR_URL=https://app.example.com/calendar/error

# OpenAI (para detecciÃ³n NLP)
OPENAI_API_KEY=sk-xxx
```

## ConfiguraciÃ³n n8n

### Tool: Crear Evento

```
Name: crear_evento
Description: Crear un nuevo evento en el calendario
Method: POST
URL: {{$vars.API_URL}}/api/v1/tenants/{{$vars.TENANT_ID}}/agent/calendar/event
Authentication: Bearer Token
Body (JSON):
{
    "title": "{title}",
    "date": "{date}",
    "time": "{time}",
    "duration_minutes": {duration},
    "location": "{location}",
    "user_phone": "{{$json.user_phone}}"
}
```

### Tool: Listar Eventos

```
Name: listar_eventos
Description: Ver eventos del calendario
Method: GET
URL: {{$vars.API_URL}}/api/v1/tenants/{{$vars.TENANT_ID}}/agent/calendar/events
Query Parameters:
- date: {date}
- user_phone: {{$json.user_phone}}
```

### Tool: Detectar Evento

```
Name: detectar_evento
Description: Detectar si un mensaje contiene un evento agendable
Method: POST
URL: {{$vars.API_URL}}/api/v1/tenants/{{$vars.TENANT_ID}}/agent/calendar/detect
Body:
{
    "message": "{message}",
    "user_phone": "{{$json.user_phone}}"
}
```

## Pruebas con curl

```bash
# Crear evento
curl -X POST "https://api.example.com/api/v1/tenants/{tenant_id}/agent/calendar/event" \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{"title": "ReuniÃ³n", "date": "2026-02-10", "time": "14:00"}'

# Listar eventos
curl "https://api.example.com/api/v1/tenants/{tenant_id}/agent/calendar/events?date=2026-02-10" \
  -H "Authorization: Bearer {token}"

# Detectar evento
curl -X POST "https://api.example.com/api/v1/tenants/{tenant_id}/agent/calendar/detect" \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{"message": "MaÃ±ana tengo turno con el mÃ©dico a las 9", "user_phone": "+5491155551234"}'
```
