---
description: Reglas del proyecto HomeAI API
globs:
  - "**/*"
---

# HomeAI API - Backend Principal

## Proyecto
- **Nombre**: HomeAI Backend
- **Repositorio**: git@github.com:pablodma/homeAssistant-backend.git
- **Stack**: FastAPI + PostgreSQL + asyncpg
- **Deploy**: Railway (https://homeassistant-backend-production.up.railway.app)
- **Fase actual**: 2 (MVP - Código propio, sin N8N)

## Arquitectura General

```
┌─────────────────────────────────────────────────────────────────┐
│                         ARQUITECTURA                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────┐     ┌──────────────┐     ┌──────────────────┐    │
│  │ WhatsApp │────▶│ homeai-assis │────▶│ homeai-api       │    │
│  │ (Meta)   │◀────│ (Bot)        │     │ (Backend)        │    │
│  └──────────┘     └──────┬───────┘     └────────┬─────────┘    │
│                          │                       │               │
│                          │    ┌─────────────────┐│               │
│                          └───▶│ PostgreSQL      │◀               │
│                               │ (Railway)       │                │
│  ┌──────────┐                 └─────────────────┘               │
│  │ Browser  │────▶┌──────────────┐                              │
│  └──────────┘     │ homeai-web   │──────────────────────────────┘
│                   │ (Vercel)     │
│                   └──────────────┘
└─────────────────────────────────────────────────────────────────┘
```

## Polyrepo

```
Estructura local:
d:\Proyectos\homeAsiss\           ← Carpeta contenedora (NO es repo)
├── homeai-api/                   ← ESTE PROYECTO (Backend → Railway)
├── homeai-web/                   ← Frontend Next.js → Vercel
├── homeai-assis/                 ← Bot WhatsApp (→ Railway)
└── .credentials/                 ← Credenciales (NO commitear)

Repositorios GitHub:
├── homeAssistant-backend         ← ESTE REPO
├── homeAssistant-frontend        
└── homeAssistant-asistant        

URLs de Deploy:
├── Backend:  https://homeassistant-backend-production.up.railway.app
├── Frontend: https://homeassistant-frontend.vercel.app
└── Bot:      https://homeai-assis-production.up.railway.app
```

## Responsabilidades de este Servicio

| Responsabilidad | Descripción |
|-----------------|-------------|
| **Autenticación** | JWT tokens, Google OAuth |
| **Multi-tenancy** | Gestión de tenants y usuarios |
| **Finance** | Gastos, presupuestos, reportes |
| **Calendar** | Eventos, integración Google Calendar |
| **Admin API** | Endpoints para panel de administración |

## Comunicación entre Servicios

| Origen | Destino | Método | Propósito |
|--------|---------|--------|-----------|
| Frontend → Backend | REST | CRUD operaciones, auth |
| Bot → Backend | REST | Finance API, Calendar API |
| Bot → DB | asyncpg | Reminders, Shopping, Vehicles, Logs |
| Backend → Google | OAuth2 | Calendar sync |

## Estructura del Proyecto

```
homeai-api/
├── src/app/
│   ├── config/           # Settings, database pool
│   ├── routers/          # API endpoints
│   │   ├── admin.py      # Panel admin endpoints
│   │   ├── auth.py       # Autenticación
│   │   ├── calendar.py   # Eventos y Google Calendar
│   │   ├── finance.py    # Gastos y presupuestos
│   │   ├── health.py     # Health checks
│   │   └── tenants.py    # Gestión de tenants
│   ├── services/         # Business logic
│   ├── repositories/     # Data access layer
│   ├── schemas/          # Pydantic models
│   └── middleware/       # Auth middleware
├── scripts/db/           # SQL migrations
├── tests/
├── docs/
│   └── prompts/          # Agent prompts de referencia
├── .cursor/rules/        # Cursor rules
├── Dockerfile
└── pyproject.toml
```

## Multi-tenancy (CRÍTICO)

```
⚠️ REGLA DE ORO: TODA query a PostgreSQL DEBE incluir WHERE tenant_id = $tenant_id
```

- **Estrategia**: Shared tables con `tenant_id` como discriminador
- **Índices**: Siempre compuestos con `tenant_id` como primer campo
- **Validación**: Middleware verifica tenant_id del JWT contra recursos
- **RLS**: Row Level Security como segunda capa de defensa

## Endpoints API

### Autenticación
| Método | Endpoint | Descripción |
|--------|----------|-------------|
| POST | `/api/v1/auth/register` | Registro de usuario |
| POST | `/api/v1/auth/login` | Login → JWT |
| GET | `/api/v1/auth/me` | Usuario actual |

### Finance
| Método | Endpoint | Descripción |
|--------|----------|-------------|
| POST | `/api/v1/tenants/{id}/agent/expense` | Registrar gasto (usado por bot) |
| GET | `/api/v1/tenants/{id}/agent/report` | Reporte de gastos |
| GET | `/api/v1/tenants/{id}/agent/budget` | Estado de presupuesto |
| GET | `/api/v1/tenants/{id}/expenses` | Listar gastos (web) |
| POST | `/api/v1/tenants/{id}/budgets` | Crear presupuesto |

### Calendar
| Método | Endpoint | Descripción |
|--------|----------|-------------|
| POST | `/api/v1/tenants/{id}/agent/calendar/events` | Crear evento |
| GET | `/api/v1/tenants/{id}/agent/calendar/events` | Listar eventos |
| GET | `/api/v1/tenants/{id}/calendar/oauth/url` | URL OAuth Google |
| GET | `/api/v1/tenants/{id}/calendar/oauth/callback` | Callback OAuth |

### Admin
| Método | Endpoint | Descripción |
|--------|----------|-------------|
| GET | `/api/v1/tenants/{id}/admin/agents` | Lista agentes |
| GET | `/api/v1/tenants/{id}/admin/agents/{name}/prompt` | Obtener prompt |
| PUT | `/api/v1/tenants/{id}/admin/agents/{name}/prompt` | Actualizar prompt |
| GET | `/api/v1/tenants/{id}/admin/interactions` | Lista interacciones |
| GET | `/api/v1/tenants/{id}/admin/interactions/{id}` | Detalle interacción |
| GET | `/api/v1/tenants/{id}/admin/stats` | Estadísticas |

## Base de Datos

### Tablas Principales

| Tabla | Responsable | Descripción |
|-------|-------------|-------------|
| `tenants` | Backend | Hogares/cuentas |
| `users` | Backend | Usuarios del sistema |
| `expenses` | Backend | Gastos registrados |
| `budgets` | Backend | Presupuestos mensuales |
| `events` | Backend | Eventos de calendario |
| `google_calendar_credentials` | Backend | OAuth tokens Google |
| `agent_prompts` | Backend | Prompts editables (versionados) |
| `agent_interactions` | Bot | Log de interacciones |
| `chat_sessions` | Bot | Sesiones de chat |
| `chat_messages` | Bot | Mensajes de chat |
| `reminders` | Bot | Recordatorios |
| `shopping_items` | Bot | Items de listas de compras |
| `vehicles` | Bot | Vehículos |
| `vehicle_services` | Bot | Servicios de vehículos |
| `vehicle_reminders` | Bot | Recordatorios de vehículos |

### Migraciones
Ubicación: `scripts/db/`
- `001_initial.sql` - Estructura inicial
- `002_calendar_sync.sql` - Google Calendar integration
- `003_agent_admin.sql` - Tablas de admin y bot

## Variables de Entorno

| Variable | Descripción | Requerida |
|----------|-------------|-----------|
| `DATABASE_URL` | PostgreSQL connection string | ✅ |
| `JWT_SECRET_KEY` | Secret para firmar JWT | ✅ |
| `JWT_ALGORITHM` | Algoritmo JWT (HS256) | ✅ |
| `GOOGLE_CLIENT_ID` | OAuth Google | ✅ |
| `GOOGLE_CLIENT_SECRET` | OAuth Google | ✅ |
| `FRONTEND_URL` | URL del frontend | ✅ |
| `PORT` | Puerto (Railway lo setea) | Auto |

## Debugging con Railway MCP

**SIEMPRE usar herramientas MCP de Railway para debugging:**

```python
# Obtener logs de deploy
Railway_HomeAs-get-logs(
    workspacePath="d:\\Proyectos\\homeAsiss\\homeai-api", 
    logType="deploy", 
    lines=100
)

# Buscar errores específicos
Railway_HomeAs-get-logs(
    workspacePath="d:\\Proyectos\\homeAsiss\\homeai-api", 
    logType="deploy", 
    filter="@level:error"
)

# Ver deployments recientes
Railway_HomeAs-list-deployments(
    workspacePath="d:\\Proyectos\\homeAsiss\\homeai-api", 
    json=true
)

# Ver variables de entorno
Railway_HomeAs-list-variables(
    workspacePath="d:\\Proyectos\\homeAsiss\\homeai-api"
)
```

## Testing

- **Framework**: pytest + pytest-asyncio
- **DB Testing**: Fixtures con base de datos de test
- **Multi-tenant**: Tests de aislamiento obligatorios
- **Ejecutar**: `pytest tests/`

## Workflow de Desarrollo

1. **Antes de commitear**: Ejecutar tests y linter
2. **Antes de push a main**: Verificar que compile localmente
3. **Después de push**: Monitorear deploy en Railway
4. **En caso de error**: Revisar logs con Railway MCP

## Notas Importantes

- **NO usar N8N** - Toda la lógica está en código Python
- **NO exponer credenciales** - Usar variables de entorno
- **NO queries sin tenant_id** - Multi-tenancy es obligatorio
- **SIEMPRE usar MCP tools** - No pedir al usuario que ejecute comandos
