---
description: Reglas del proyecto HomeAI API
globs:
  - "**/*"
---

# HomeAI API

## Proyecto
- **Nombre**: HomeAI Backend
- **Repositorio**: git@github.com:pablodma/homeAssistant-backend.git
- **Stack**: FastAPI + PostgreSQL
- **Deploy**: Railway
- **Fase actual**: 1 (POC)

## Arquitectura Polyrepo

```
Estructura local:
d:\Proyectos\homeAsiss\           ← Carpeta contenedora (NO es repo)
├── homeai-api/                   ← ESTE PROYECTO (FastAPI → Railway)
├── homeai-web/                   ← Frontend Next.js → Vercel
└── homeai-assis/                 ← Bot WhatsApp (FastAPI → Railway) ✅

Repositorios GitHub:
├── homeAssistant-backend         ← ESTE REPO
├── homeAssistant-frontend        ← Frontend
└── homeAssistant-asistant        ← Bot WhatsApp ✅
```

**URLs de Repositorios:**
- Backend: git@github.com:pablodma/homeAssistant-backend.git
- Frontend: git@github.com:pablodma/homeAssistant-frontend.git
- Asistente: git@github.com:pablodma/homeAssistant-asistant.git

**URLs de Deploy:**
- Backend: https://homeassistant-backend-production.up.railway.app
- Frontend: https://homeassistant-frontend.vercel.app
- Bot: https://homeai-assis-production.up.railway.app

## Comunicación entre servicios
- Frontend → Backend: REST via `NEXT_PUBLIC_API_URL`
- Bot → Backend: REST via `BACKEND_API_URL` (para Finance, Calendar)
- Bot → WhatsApp: Meta Cloud API (webhook)
- Bot → OpenAI: API para LLM
- Contratos API definidos en `/docs/api/openapi.yaml`

## Multi-tenancy (CRÍTICO)
- Estrategia: Shared tables con `tenant_id` en CADA tabla
- TODA query a PostgreSQL DEBE incluir `WHERE tenant_id = $tenant_id`
- NUNCA acceder a datos sin filtrar por tenant_id
- Los índices compuestos SIEMPRE tienen tenant_id como primer campo

## Estructura
```
homeAssistant-backend/
├── src/app/
│   ├── config/        # Settings, database
│   ├── routers/       # API endpoints (finance, calendar, auth, tenants)
│   ├── services/      # Business logic
│   ├── repositories/  # Data access
│   ├── schemas/       # Pydantic models
│   └── middleware/    # Auth, CORS
├── tests/
├── docs/
├── scripts/db/
├── .cursor/rules/     # Cursor rules (calendar-agent.mdc, etc.)
├── Dockerfile
└── pyproject.toml
```

## Agentes Implementados

### Finance Agent ✅
- Gestión de gastos y presupuestos
- Endpoints: `/agent/expense`, `/agent/report`, `/agent/budget`
- Prompt: `docs/prompts/finance-agent.md`

### Calendar Agent ✅
- Gestión de eventos con sincronización Google Calendar
- OAuth individual por usuario via WhatsApp
- Endpoints: `/agent/calendar/*`
- Regla Cursor: `.cursor/rules/calendar-agent.mdc`
- Prompt: `docs/prompts/calendar-agent.md`

### Reminder Agent ✅ (en homeai-assis)
- Recordatorios y alertas
- Almacenamiento en DB: tabla `reminders`

### Shopping Agent ✅ (en homeai-assis)
- Listas de compras
- Almacenamiento en DB: tabla `shopping_items`

### Vehicle Agent ✅ (en homeai-assis)
- Gestión de vehículos y mantenimiento
- Almacenamiento en DB: tablas `vehicles`, `vehicle_services`, `vehicle_reminders`

## Panel de Administración

El backend expone endpoints admin para gestionar los agentes:

### Endpoints Admin
- `GET /api/v1/tenants/{tenant_id}/admin/agents` - Lista todos los agentes
- `GET /api/v1/tenants/{tenant_id}/admin/agents/{name}/prompt` - Obtener prompt de un agente
- `PUT /api/v1/tenants/{tenant_id}/admin/agents/{name}/prompt` - Actualizar prompt
- `GET /api/v1/tenants/{tenant_id}/admin/interactions` - Lista interacciones
- `GET /api/v1/tenants/{tenant_id}/admin/stats` - Estadísticas

### Tablas de Admin
- `agent_prompts` - Prompts editables por agente (versionados)
- `agent_interactions` - Log de todas las interacciones del bot

**Flujo OAuth Google Calendar:**
1. Bot detecta que usuario no tiene calendario conectado
2. Envía link de autorización por WhatsApp
3. Usuario autoriza en Google
4. Callback guarda tokens en `google_calendar_credentials`
5. Frontend muestra página de éxito/error
6. Bot confirma conexión exitosa

**Tablas de DB:**
- `events` - Eventos con campos de sync (google_event_id, sync_status, source)
- `google_calendar_credentials` - OAuth tokens por usuario
- `oauth_states` - Estados temporales para flujo OAuth

## Debugging con Railway MCP (OBLIGATORIO)

**SIEMPRE que trabajes con este backend, usa las herramientas MCP de Railway para debugging:**

### Herramientas disponibles:
- `Railway_HomeAs-get-logs`: Obtener logs de build o deploy
- `Railway_HomeAs-list-deployments`: Ver lista de deployments con IDs y estados
- `Railway_HomeAs-list-services`: Ver servicios disponibles
- `Railway_HomeAs-list-variables`: Ver variables de entorno

### Cuándo usar:
1. **Al investigar errores**: Siempre obtener logs de Railway antes de proponer soluciones
2. **Después de un deploy**: Verificar que el servicio arrancó correctamente
3. **Al debuggear issues de producción**: Usar `filter` para buscar errores específicos
4. **Al verificar configuración**: Consultar variables de entorno en Railway

### Ejemplo de uso:
```
# Para obtener logs de deploy (últimas 100 líneas):
Railway_HomeAs-get-logs(workspacePath="d:\\Proyectos\\homeAsiss\\homeai-api", logType="deploy", lines=100)

# Para buscar errores específicos:
Railway_HomeAs-get-logs(workspacePath="d:\\Proyectos\\homeAsiss\\homeai-api", logType="deploy", filter="@level:error")

# Para ver deployments recientes:
Railway_HomeAs-list-deployments(workspacePath="d:\\Proyectos\\homeAsiss\\homeai-api", json=true)
```

**IMPORTANTE**: No asumas el estado del servicio. SIEMPRE consulta Railway para obtener información real.

## Testing de Endpoints (OBLIGATORIO)

**NUNCA pidas al usuario que ejecute curl o pruebe endpoints manualmente. SIEMPRE ejecuta los comandos directamente:**

- Usa la herramienta Shell para ejecutar `curl` o `Invoke-RestMethod` directamente
- Verifica respuestas de la API sin intervención del usuario
- Si necesitas probar un endpoint, hazlo tú mismo

### Ejemplo:
```powershell
# En lugar de decir "ejecuta este curl", ejecutarlo directamente:
curl -X GET "https://api.example.com/endpoint" -H "Authorization: Bearer $token"
```
